<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Controle de Gastos</title>
<style>
:root{
  /* Flamengo theme */
  --bg:#0a0a0a; --card:#111111; --muted:#9ca3af; --txt:#fafafa; --sub:#e5e7eb;
  --primary:#dc2626; --primary2:#ef4444; --ok:#22c55e; --danger:#ef4444;
  --shadow:0 8px 30px rgba(0,0,0,.45)
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--txt);font:500 16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
h1,h2,h3,p{margin:0}
.container{max-width:980px;margin:0 auto;padding:20px 16px 120px}

/* Header */
.header{display:flex;align-items:center;gap:12px}
.burger{width:44px;height:44px;border-radius:12px;background:#121212;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer;border:1px solid #1f1f1f}
.burger:before{content:"";width:18px;height:2px;background:#fff;box-shadow:0 6px 0 #fff,0 -6px 0 #fff;opacity:.9}

/* Saldo card (somente na Conta) */
.saldo{
  margin:10px 0 18px;border-radius:22px;padding:22px;
  background:linear-gradient(135deg,#1a1a1a 0,#7f1d1d 40%,#b91c1c 60%,#1a1a1a 100%);
  border:1px solid #2a2a2a; box-shadow:var(--shadow)
}
.saldo .total{font-size:44px;font-weight:900;letter-spacing:.3px;margin-top:2px}
.row{display:flex;gap:14px;flex-wrap:wrap;margin-top:14px}
.badge{display:flex;align-items:center;gap:8px;background:#141414;border:1px solid #272727;
padding:10px 14px;border-radius:14px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.in{background:var(--ok)} .dot.out{background:var(--danger)}

/* Filtros Conta */
.filtros{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.select, .month{background:#121212;border:1px solid #272727;border-radius:12px;padding:8px 10px;color:#f5f5f5}

/* Stat mini card √∫nico */
.stat{flex:1 1 260px;background:#121212;border:1px solid #272727;border-radius:18px;padding:16px}
.stat .v{font-size:28px;font-weight:800}

/* Cards (Cart√µes) */
.cards-wrap{margin-top:16px;display:flex;gap:16px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:8px}
.card-group{min-width:88%;scroll-snap-align:center}
.card{width:100%;height:220px;border-radius:22px;position:relative;overflow:hidden;border:1px solid #272727;box-shadow:var(--shadow);cursor:pointer}
.card .label{position:absolute;left:20px;bottom:18px;font-size:22px;font-weight:800;text-shadow:0 2px 16px rgba(0,0,0,.6)}
.card .edit-btn{position:absolute;right:16px;top:16px;width:36px;height:36px;border-radius:10px;background:rgba(0,0,0,.4);display:grid;place-items:center;border:1px solid rgba(255,255,255,.2);cursor:pointer}
.card input[type=file]{display:none}
.bg-nu{background:linear-gradient(135deg,#111 0,#7f1d1d 40%,#b91c1c 100%)}
.bg-hiper{background:linear-gradient(160deg,#7a1e1e 0,#991b1b 40%,#ef4444 120%)}

/* Saldo logo abaixo do card */
.card-balance{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
.card-balance .pill{display:inline-flex;align-items:center;gap:8px;background:#121212;border:1px solid #2a2a2a;color:#f3f4f6;
padding:10px 12px;border-radius:12px;font-weight:700}
.card-balance .pill .dot{width:8px;height:8px}
.card-balance .neg{color:#fca5a5} .card-balance .pos{color:#86efac}

/* Listas */
.list{margin-top:10px;display:grid;gap:10px}
.item{background:#121212;border:1px solid #272727;border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:12px}
.item .logo{width:40px;height:40px;border-radius:12px;background:#0f0f0f;display:grid;place-items:center;overflow:hidden;border:1px solid #2a2a2a}
.item .logo img{width:100%;height:100%;object-fit:cover}
.item .meta{flex:1}
.item .meta .t{font-weight:800}
.item .meta .s{color:var(--muted);font-size:13px}
.item .val{font-weight:900}
.val.pos{color:var(--ok)} .val.neg{color:var(--danger)}

/* Swipe (Conta) */
.swipe-wrap{position:relative;overflow:hidden;border-radius:16px}
.swipe-bg{position:absolute;inset:0;display:grid;place-items:center;color:#e5f7ff;font-weight:800;opacity:0;transition:.2s;pointer-events:none}
.swipe-bg.mark{background:rgba(34,197,94,.18);border:1px dashed rgba(34,197,94,.35)}
.swipe-bg.unmark{background:rgba(239,68,68,.18);border:1px dashed rgba(239,68,68,.35)}
.swipe-wrap.active .swipe-bg{opacity:1}
.swipe-fore{position:relative;touch-action:pan-y;}

/* FAB */
.fab{position:fixed;right:18px;bottom:22px;width:70px;height:70px;border-radius:22px;background:var(--primary);display:grid;place-items:center;
box-shadow:0 18px 40px rgba(220,38,38,.45);cursor:pointer;border:1px solid rgba(255,255,255,.12);z-index:60}
.fab span{font-size:36px;font-weight:900}

/* Backdrop */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(120%) blur(6px);opacity:0;visibility:hidden;transition:.2s;z-index:70}
.backdrop.show{opacity:1;visibility:visible}

/* Bottom Sheet */
.sheet{position:fixed;left:0;right:0;bottom:-100%;background:#0d0d0d;border-top:1px solid #222;border-radius:22px 22px 0 0;
box-shadow:0 -22px 40px rgba(0,0,0,.55);transition:transform .25s ease, bottom .25s ease;transform:translateY(0);z-index:80;max-height:86vh;display:flex;flex-direction:column}
.sheet.open{bottom:0}
.sheet .grab{width:64px;height:5px;background:#2b2b2b;border-radius:9px;margin:12px auto}
.sheet header{display:flex;align-items:center;justify-content:space-between;padding:0 16px 10px;gap:8px}
.sheet header h3{font-size:18px}
.sheet .body{padding:0 16px 16px;overflow:auto}
.sheet .grid{display:grid;gap:10px}
input,select,textarea{width:100%;padding:14px 14px;border-radius:14px;border:1px solid #2a2a2a;background:#121212;color:#fff}
textarea{min-height:110px;resize:vertical}
.btn{padding:12px 14px;border-radius:14px;border:1px solid #2c2c2c;background:#171717;color:#f3f4f6;cursor:pointer}
.btn.primary{background:var(--primary);border-color:#b91c1c;color:#fff}
.btn.danger{background:#2a1313;border-color:#4d1919;color:#fda4af}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

/* Drawer */
.drawer{position:fixed;inset:0 35% 0 0;max-width:320px;background:#0d0d0d;border-right:1px solid #272727;transform:translateX(-100%);
transition:.25s;z-index:90;padding:18px}
.drawer.show{transform:translateX(0)}
.drawer h4{margin:4px 0 12px}
.drawer .muted{color:var(--muted);font-size:14px}

/* Views */
.view{display:none}
.view.show{display:block}
.muted{color:var(--muted)}
.pill-mini{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #3a3a3a;background:#151515;color:#fde68a;font-size:12px}

/* Toast */
.toast{position:fixed;left:50%;transform:translateX(-50%) translateY(20px);
bottom:18px;background:#121212;border:1px solid #272727;color:#e7e7e7;padding:12px 16px;border-radius:14px;
box-shadow:0 12px 28px rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:.25s;z-index:100}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-color:#1e3a2f;color:#d1fae5}
.toast.danger{border-color:#3a1e1e;color:#fee2e2}

/* Fancy switch (Fixo no ano) */
.switch{display:flex;align-items:center;gap:10px}
.switch input{display:none}
.switch .track{width:52px;height:28px;border-radius:999px;background:#1a1a1a;border:1px solid #2f2f2f;display:inline-block;position:relative;transition:.2s}
.switch .track .dot{position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:#2a2a2a;transition:.2s;border:1px solid #3a3a3a}
.switch input:checked + .track{background:#861212;border-color:#a31616}
.switch input:checked + .track .dot{left:27px;background:#dc2626;border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.15)}
.switch .swlabel{color:#e5e5e5}
</style>
</head>
<body>
<div class="container">

  <!-- Drawer -->
  <div id="drawer" class="drawer">
    <h3>Menu</h3>
    <p class="muted">Navegue pelas se√ß√µes.</p>
    <div class="list">
      <div class="item" data-go="cartoes"><div class="logo">üí≥</div><div class="meta"><div class="t">Cart√µes</div><div class="s">Lan√ßamentos por cart√£o</div></div></div>
      <div class="item" data-go="conta"><div class="logo">üè¶</div><div class="meta"><div class="t">Conta</div><div class="s">Entradas e sa√≠das</div></div></div>
      <div class="item" data-go="hora"><div class="logo">‚è±Ô∏è</div><div class="meta"><div class="t">Hora extra</div><div class="s">Saldo de horas (R$)</div></div></div>
      <div class="item" data-go="notas"><div class="logo">üìù</div><div class="meta"><div class="t">Notas</div><div class="s">Bloco pessoal</div></div></div>
    </div>
  </div>

  <!-- Backdrop -->
  <div id="backdrop" class="backdrop"></div>

  <!-- Header -->
  <div class="header">
    <div id="btnMenu" class="burger" aria-label="Menu"></div>
    <div>
      <h1 style="font-size:32px;font-weight:900">Controle de Gastos</h1>
      <p class="muted">Cart√µes como tela principal. Toque no card para ver os lan√ßamentos.</p>
    </div>
  </div>

  <!-- View: Conta -->
  <section id="conta" class="view">
    <div class="saldo">
      <div class="muted">Saldo geral (somente itens <b>pagos</b>)</div>
      <div id="saldoGeral" class="total">R$ 0,00</div>
      <div class="row">
        <div class="badge"><span class="dot in"></span> Entradas <b id="totalIn" style="margin-left:8px">R$ 0,00</b></div>
        <div class="badge"><span class="dot out"></span> Sa√≠das <b id="totalOut" style="margin-left:8px">R$ 0,00</b></div>
      </div>
      <!-- Filtros -->
      <div class="filtros">
        <input id="filtroMesCal" type="month" class="month">
        <select id="filtroCat" class="select"></select>
      </div>
    </div>

    <!-- √önico card: saldo do m√™s (todos os lan√ßamentos, pagos ou n√£o) -->
    <div class="row">
      <div class="stat" style="flex:1">
        <div class="muted">Saldo do m√™s (todos)</div>
        <div id="saldoMesTodos" class="v">R$ 0,00</div>
      </div>
    </div>

    <h3 style="margin:18px 0 8px">Registros</h3>
    <div id="listaConta" class="list"></div>
  </section>

  <!-- View: Cart√µes -->
  <section id="cartoes" class="view show">
    <div class="cards-wrap" id="cardsWrap">
      <!-- via JS -->
    </div>
  </section>

  <!-- View: Hora extra -->
  <section id="hora" class="view">
    <div class="stat" style="margin:10px 0 16px">
      <div class="muted">Saldo (R$)</div>
      <h1 id="saldoHoras" style="font-size:36px">R$ 0,00</h1>
    </div>
    <h3 style="margin:10px 0 8px">Registros de horas</h3>
    <div id="listaHoras" class="list"></div>
  </section>

  <!-- View: Notas -->
  <section id="notas" class="view">
    <div class="row">
      <div class="stat" style="flex:1">
        <div class="muted">Suas notas</div>
        <div id="listaNotas" class="list" style="margin-top:10px"></div>
      </div>
    </div>
  </section>

</div>

<!-- Toast -->
<div id="toast" class="toast">Opera√ß√£o conclu√≠da</div>

<!-- FAB -->
<button id="fab" class="fab" aria-label="Adicionar"><span>+</span></button>

<!-- Sheet: Lan√ßamento financeiro -->
<div id="sheetLancamento" class="sheet">
  <div class="grab"></div>
  <header>
    <h3 id="titleLanc">Novo lan√ßamento</h3>
    <div style="display:flex;gap:8px">
      <button id="btnExcluirLancTopo" class="btn danger" style="display:none">Excluir</button>
      <button class="btn" data-close="#sheetLancamento">Fechar</button>
    </div>
  </header>
  <div class="body">
    <div class="grid">
      <select id="tipoMov">
        <option value="receita">Receita</option>
        <option value="despesa" selected>Despesa</option>
      </select>
      <input id="descMov" placeholder="Descri√ß√£o (ex: Sal√°rio, Luz, Mercado)">
      <div class="row" style="gap:10px">
        <input id="valorMov" inputmode="decimal" placeholder="Valor (ex: 123,45)" style="flex:1">
        <input id="dataMov" type="date" style="flex:1">
      </div>
      <div class="row" style="gap:10px">
        <select id="categoriaMov" style="flex:1">
          <optgroup label="Receitas">
            <option>Sal√°rio</option><option>Pix</option><option>Cashback</option><option>Presente</option>
            <option>Investimento</option><option>Outros</option>
          </optgroup>
          <optgroup label="Despesas">
            <option>Luz</option><option>√Ågua</option><option>Internet</option><option>Assinaturas</option>
            <option>Mercado</option><option>Transporte</option><option>Sa√∫de</option><option>Educa√ß√£o</option>
            <option>Impostos</option><option selected>Cart√£o</option><option>Outros</option>
          </optgroup>
        </select>
        <select id="metodoMov" style="flex:1"></select>
      </div>

      <div id="fixoWrap" class="row" style="gap:8px;align-items:center;display:none">
        <label class="switch">
          <input id="fixoAno" type="checkbox">
          <span class="track"><span class="dot"></span></span>
          <span class="swlabel">Fixo no ano</span>
        </label>
      </div>

      <label class="muted">√çcone/Logo (opcional)</label>
      <input id="logoMov" type="file" accept="image/*">

      <div class="actions">
        <button id="salvarMov" class="btn primary">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Sheet: Detalhe do Cart√£o -->
<div id="sheetCartao" class="sheet">
  <div class="grab"></div>
  <header>
    <h3 id="cartaoTitulo">Cart√£o</h3>
    <div style="display:flex;gap:8px">
      <button class="btn" data-close="#sheetCartao">Fechar</button>
    </div>
  </header>
  <div class="body">
    <div id="cartaoHero" class="card" style="min-width:100%;height:210px;margin-bottom:12px"></div>

    <div class="row" style="justify-content:space-between;align-items:center;margin:6px 2px 10px">
      <div class="badge">Saldo total: <b id="saldoTotalCartao" style="margin-left:8px">R$ 0,00</b></div>
      <button class="btn" id="btnPagarFatura">Pagar fatura</button>
    </div>

    <h3 style="margin:10px 0 8px">Atividade recente</h3>
    <div id="listaCartao" class="list"></div>
    <div class="muted" style="font-size:13px;margin-top:6px">Toque para <b>editar</b> um lan√ßamento.</div>
  </div>
</div>

<!-- Sheet: Hora extra -->
<div id="sheetHora" class="sheet">
  <div class="grab"></div>
  <header>
    <h3>Registrar horas</h3>
    <div style="display:flex;gap:8px">
      <button id="btnExcluirHoraTopo" class="btn danger" style="display:none">Excluir</button>
      <button class="btn" data-close="#sheetHora">Fechar</button>
    </div>
  </header>
  <div class="body">
    <div class="grid">
      <input id="dataHora" type="date">
      <div class="row" style="gap:10px">
        <input id="entradaHora" type="time" style="flex:1" value="18:00">
        <input id="saidaHora" type="time" style="flex:1" value="22:00">
      </div>
      <input id="almocoHora" type="time" value="00:00" aria-label="Almo√ßo (descontar)">
      <div class="row" style="gap:10px">
        <select id="percentHora" style="flex:1"><option value="50">+50%</option><option value="100">+100%</option></select>
        <input id="salarioHora" inputmode="decimal" placeholder="Sal√°rio/hora (opcional)" style="flex:1">
      </div>
      <div class="actions">
        <button id="salvarHora" class="btn primary">Salvar horas</button>
      </div>
    </div>
  </div>
</div>

<!-- Sheet: Nova nota -->
<div id="sheetNota" class="sheet">
  <div class="grab"></div>
  <header><h3>Nova nota</h3><button class="btn" data-close="#sheetNota">Fechar</button></header>
  <div class="body">
    <input id="tituloNota" placeholder="T√≠tulo">
    <textarea id="textoNota" placeholder="Escreva aqui..."></textarea>
    <div class="actions"><button id="salvarNota" class="btn primary">Salvar</button></div>
  </div>
</div>

<script>
/* Helpers */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const brl = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load = (k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}};
const today = ()=> new Date().toISOString().slice(0,10);
const normMoney = s => typeof s==='number'? s : Number(String(s||'0').replace(/\./g,'').replace(',','.'));
const monthStr = (d)=> d.toISOString().slice(0,7);

/* Toast */
let toastTimer=null;
function toast(msg,type='success'){
  const el=$('#toast'); el.textContent=msg; el.className='toast show '+type;
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>{ el.classList.remove('show'); }, 1900);
}

/* Estado */
let lancamentos = load('lancamentos', []); // {id,tipo,desc,valor,data,categoria,metodo,logoData,status,seriesId?}
let horas = load('horas', []); // {id,data,entrada,saida,almocoMin,percent,salarioHora,minutos,valor,pago?}
let cards = load('cards', [
  {id:'nubank', nome:'Nubank Gold', final:'7562', img:'nu', bg:'nu'},
  {id:'hiper',  nome:'Hipercard',  final:'2016', img:'hiper', bg:'hiper'}
]);

/* Navega√ß√£o por views */
function setView(v){
  $$('.view').forEach(s=>s.classList.remove('show'));
  $('#'+v).classList.add('show');
  render();
}
function currentView(){
  if($('#cartoes').classList.contains('show')) return 'cartoes';
  if($('#conta').classList.contains('show'))   return 'conta';
  if($('#hora').classList.contains('show'))    return 'hora';
  return 'notas';
}

/* Drawer + backdrop */
const drawer = $('#drawer');
const backdrop = $('#backdrop');
function openDrawer(){ drawer.classList.add('show'); backdrop.classList.add('show'); }
function closeDrawer(){ drawer.classList.remove('show'); backdrop.classList.remove('show'); }
$('#btnMenu').onclick=openDrawer;
backdrop.addEventListener('click', ()=>{
  if(drawer.classList.contains('show')) closeDrawer();
  closeAllSheets();
});
drawer.querySelectorAll('[data-go]').forEach(it=>{
  it.addEventListener('click', ()=>{ setView(it.dataset.go); closeDrawer(); });
});

/* Sheets */
function openSheet(id){ backdrop.classList.add('show'); $(id).classList.add('open'); }
function closeSheet(id){ $(id).classList.remove('open'); backdrop.classList.remove('show'); }
function closeAllSheets(){ $$('.sheet.open').forEach(s=>s.classList.remove('open')); }

/* Swipe-down para fechar */
$$('.sheet').forEach(s=>{
  let startY=null, lastDy=0; const body = s.querySelector('.body');
  s.addEventListener('touchstart',e=>{ if(body.scrollTop>0) return; startY=e.touches[0].clientY; lastDy=0; },{passive:true});
  s.addEventListener('touchmove',e=>{ if(startY==null) return; lastDy=e.touches[0].clientY-startY; if(lastDy>0){ s.style.transform=`translateY(${Math.min(lastDy,180)}px)`; } },{passive:true});
  const end=()=>{ if(startY==null) return; if(lastDy>100){ s.style.transform=''; closeSheet('#'+s.id); } else s.style.transform=''; startY=null; lastDy=0; };
  s.addEventListener('touchend',end); s.addEventListener('touchcancel',end);
});
$$('[data-close]').forEach(b=>b.onclick=()=>closeSheet(b.dataset.close));

/* ======= FILTROS CONTA ======= */
function buildFiltrosConta(){
  const mInput = $('#filtroMesCal');
  if(!mInput.value) mInput.value = monthStr(new Date());
  mInput.onchange=renderConta;
  const selectCat = $('#filtroCat');
  const catsSet = new Set(lancamentos.filter(l=>l.metodo==='conta').map(l=>l.categoria));
  const cats = Array.from(catsSet).filter(Boolean).sort();
  selectCat.innerHTML = '<option value="todas">Todas as categorias</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  selectCat.onchange=renderConta;
}

/* Renderiza√ß√µes */
function renderConta(){
  buildFiltrosConta();
  const mesSel = $('#filtroMesCal').value || monthStr(new Date());
  const catSel = $('#filtroCat').value;

  // Para saldo geral consideramos somente pagos e conta
  const base = lancamentos.filter(l=>l.metodo==='conta' && (l.status||'pendente')==='pago' && (!l.data || l.data.length>=10));
  const filtro = base.filter(l=> l.data.slice(0,7)===mesSel && (catSel==='todas' || l.categoria===catSel) );

  const ins = filtro.filter(l=>l.tipo==='receita');
  const outs = filtro.filter(l=>l.tipo==='despesa');
  const sum = arr=>arr.reduce((a,b)=>a+Number(b.valor||0),0);
  const totalIn = sum(ins), totalOut = sum(outs);
  $('#totalIn').textContent = brl(totalIn);
  $('#totalOut').textContent = brl(totalOut);
  $('#saldoGeral').textContent = brl(totalIn-totalOut);

  // Saldo do m√™s com TODOS os lan√ßamentos (sem exigir pago)
  const baseAllMes = lancamentos.filter(l=>l.metodo==='conta' && l.data.slice(0,7)===mesSel && (catSel==='todas' || l.categoria===catSel));
  const saldoTodos = sum(baseAllMes.map(l=> l.tipo==='receita' ? +l.valor : -l.valor ));
  $('#saldoMesTodos').textContent = brl(saldoTodos);

  const list = $('#listaConta'); list.innerHTML='';
  const todosConta = lancamentos.filter(l=>l.metodo==='conta' && l.data.slice(0,7)===mesSel && (catSel==='todas' || l.categoria===catSel))
    .slice().reverse();

  if(todosConta.length===0){ list.innerHTML = `<div class="item"><div class="logo">üè¶</div><div class="meta"><div class="t">Sem lan√ßamentos</div><div class="s">Toque no + para adicionar</div></div></div>`; return; }

  todosConta.forEach(l=>{
    const wrap = document.createElement('div'); wrap.className='swipe-wrap';
    const bgMark = document.createElement('div'); bgMark.className='swipe-bg mark'; bgMark.innerHTML='‚úì MARCAR COMO PAGO';
    const bgUn = document.createElement('div'); bgUn.className='swipe-bg unmark'; bgUn.innerHTML='‚ü≤ DESMARCAR PAGO';
    const fore = document.createElement('div'); fore.className='item swipe-fore'; fore.style.transition='.15s';

    fore.innerHTML = `
      <div class="logo">${l.logoData?`<img src="${l.logoData}">`:'üí†'}</div>
      <div class="meta">
        <div class="t">${l.desc} ${l.status==='pago'?'<span class="pill-mini">pago</span>':''}</div>
        <div class="s">${l.categoria} ‚Ä¢ ${new Date(l.data).toLocaleDateString()}</div>
      </div>
      <div class="val ${l.tipo==='receita'?'pos':'neg'}">${brl(l.valor)}</div>
    `;
    fore.onclick=()=>editarLancamento(l.id);
    wrap.appendChild(bgMark); wrap.appendChild(bgUn); wrap.appendChild(fore);
    list.appendChild(wrap);

    // Swipe: esquerda -> marcar pago | direita -> desmarcar pago
    let sx=0, dx=0, down=false;
    const start = (e)=>{ down=true; sx=(e.touches?e.touches[0].clientX:e.clientX); dx=0; fore.style.transition='none'; };
    const move = (e)=>{
      if(!down) return;
      const x=(e.touches?e.touches[0].clientX:e.clientX);
      dx = x - sx;
      fore.style.transform=`translateX(${dx}px)`;
      wrap.classList.add('active');
      bgMark.style.opacity = dx<0 ? 1 : 0;
      bgUn.style.opacity   = dx>0 ? 1 : 0;
    };
    const end = ()=>{
      if(!down) return; down=false; fore.style.transition='.15s';
      if(dx < -80){ marcarPago(l.id); fore.style.transform='translateX(-100%)'; setTimeout(renderConta,160); }
      else if(dx > 80){ desmarcarPago(l.id); fore.style.transform='translateX(100%)'; setTimeout(renderConta,160); }
      else { fore.style.transform=''; wrap.classList.remove('active'); bgMark.style.opacity=0; bgUn.style.opacity=0; }
    };
    fore.addEventListener('mousedown',start); fore.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
    fore.addEventListener('touchstart',start,{passive:true}); fore.addEventListener('touchmove',move,{passive:true}); fore.addEventListener('touchend',end);
  });
}

function marcarPago(id){
  const i = lancamentos.findIndex(x=>x.id===id);
  if(i>-1){ lancamentos[i].status='pago'; save('lancamentos',lancamentos); toast('Marcado como pago ‚úÖ','success'); }
}
function desmarcarPago(id){
  const i = lancamentos.findIndex(x=>x.id===id);
  if(i>-1){ lancamentos[i].status='pendente'; save('lancamentos',lancamentos); toast('Pago removido ‚ü≤','danger'); }
}

function saldoDoCartao(nome){
  const mov = lancamentos.filter(l=>l.metodo===`cartao:${nome}`);
  return mov.reduce((a,b)=>a + (b.tipo==='receita'?+b.valor:-b.valor), 0);
}
function pagarCartaoById(id){
  const c = cards.find(x=>x.id===id); if(!c) return;
  const saldo = saldoDoCartao(c.nome);
  const valor = Math.max(0, -saldo);
  if(valor<=0){ toast('Nada a pagar neste cart√£o.','danger'); return; }
  const hoje = new Date();
  const mes = hoje.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  lancamentos.push({ id: Date.now(),   tipo:'despesa',
    desc:`Pagamento fatura ${c.nome} (${mes})`, valor, data: hoje.toISOString().slice(0,10),
    categoria:'Cart√£o', metodo:'conta', logoData:null, status:'pago' });
  lancamentos.push({ id: Date.now()+1, tipo:'receita',
    desc:`Pagamento recebido - ${c.nome}`, valor, data: hoje.toISOString().slice(0,10),
    categoria:'Cart√£o', metodo:`cartao:${c.nome}`, logoData:null });
  save('lancamentos',lancamentos);
  render();
  toast('Fatura paga com sucesso üí≥','success');
}
function renderCartoes(){
  const wrap=$('#cardsWrap'); wrap.innerHTML='';
  cards.forEach(c=>{
    const group=document.createElement('div'); group.className='card-group';

    const el=document.createElement('div'); el.className='card '+(c.bg==='hiper'?'bg-hiper':'bg-nu');
    el.dataset.id=c.id;
    el.innerHTML=`
      <label class="edit-btn" title="Trocar imagem">‚úèÔ∏è<input type="file" accept="image/*"></label>
      <div class="label">${c.nome}</div>`;
    if(c.img && String(c.img).startsWith('data:')) el.style.background=`center/cover no-repeat url(${c.img})`;
    el.querySelector('input[type=file]').onchange=(ev)=>{
      const f=ev.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ c.img=r.result; save('cards',cards); renderCartoes(); }; r.readAsDataURL(f);
    };
    el.addEventListener('click',(e)=>{ if(e.target.tagName==='INPUT'||e.target.closest('label')) return; abrirCartao(c.id); });
    group.appendChild(el);

    // saldo logo abaixo do card
    const saldo = saldoDoCartao(c.nome);
    const bal = document.createElement('div'); bal.className='card-balance';
    bal.innerHTML = `<span class="pill">
        <span class="dot ${saldo>=0?'in':'out'}"></span>
        Saldo: <span class="${saldo>=0?'pos':'neg'}" style="margin-left:6px">${brl(Math.abs(saldo))}${saldo<0?' (a pagar)':''}</span>
      </span>`;
    group.appendChild(bal);

    wrap.appendChild(group);
  });
}

function renderHoras(){
  const list=$('#listaHoras'); list.innerHTML='';
  const totalMoney = horas.reduce((a,h)=>a+Number(h.valor||0),0);
  $('#saldoHoras').textContent = brl(totalMoney);

  horas.slice().reverse().forEach(h=>{
    const el=document.createElement('div'); el.className='item';
    const info = `${h.entrada}‚Äì${h.saida} ‚Ä¢ ${h.percent}% ${h.almocoMin?` ‚Ä¢ almo√ßo ${fmtMin(h.almocoMin)}`:''}`;
    el.innerHTML = `
      <div class="logo">‚è±Ô∏è</div>
      <div class="meta"><div class="t">${new Date(h.data).toLocaleDateString()} ${h.pago?'<span class="pill-mini">pago</span>':''}</div><div class="s">${info}</div></div>
      <div>
        <div class="val">${brl(h.valor||0)}</div>
        ${h.pago?'':'<button class="btn small" style="margin-top:6px" data-action="pagarHora">Pago</button>'}
      </div>
    `;
    el.onclick=(e)=>{
      if(e.target?.dataset?.action==='pagarHora'){ e.stopPropagation(); pagarHora(h.id); return; }
      editarHora(h.id);
    };
    list.appendChild(el);
  });
}

function renderNotas(){
  const list=$('#listaNotas'); list.innerHTML='';
  const ns = load('notas',[]);
  if(ns.length===0){
    list.innerHTML=`<div class="item"><div class="logo">üí°</div><div class="meta"><div class="t">Sem notas</div><div class="s">Toque no + para adicionar</div></div></div>`;
    return;
  }
  ns.slice().reverse().forEach(n=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="logo">üìù</div><div class="meta"><div class="t">${n.titulo||'Sem t√≠tulo'}</div><div class="s">${n.texto||''}</div></div>`;
    list.appendChild(el);
  });
}

function render(){ renderConta(); renderCartoes(); renderHoras(); renderNotas(); }

/* Cart√£o -> sheet */
let curCardId=null;
function abrirCartao(id){
  curCardId=id;
  const c = cards.find(x=>x.id===id); if(!c) return;
  $('#cartaoTitulo').textContent = c.nome + ' ‚Ä¢‚Ä¢' + (c.final||'');
  const hero = $('#cartaoHero'); hero.className='card'; hero.style.minWidth='100%'; hero.style.height='210px';
  hero.style.background = c.img && String(c.img).startsWith('data:') ? `center/cover no-repeat url(${c.img})`
                        : (c.bg==='hiper'?'linear-gradient(160deg,#7a1e1e 0,#991b1b 40%,#ef4444 120%)'
                                           :'linear-gradient(135deg,#111 0,#7f1d1d 40%,#b91c1c 100%)') ;
  hero.style.border='1px solid #272727'; hero.style.borderRadius='18px';
  hero.innerHTML = '';

  // saldo total ao lado do Pagar fatura
  $('#saldoTotalCartao').textContent = brl(saldoDoCartao(c.nome));

  const list=$('#listaCartao'); list.innerHTML='';
  const itens = lancamentos.filter(l=>l.metodo===`cartao:${c.nome}`);
  if(itens.length===0){
    list.innerHTML=`<div class="item"><div class="logo">üí≥</div><div class="meta"><div class="t">Sem lan√ßamentos</div><div class="s">Use o bot√£o + para registrar</div></div></div>`;
  }else{
    itens.slice().reverse().forEach(l=>{
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`
        <div class="logo">${l.logoData?`<img src="${l.logoData}">`:'üí†'}</div>
        <div class="meta"><div class="t">${l.desc}</div><div class="s">${l.categoria} ‚Ä¢ ${new Date(l.data).toLocaleDateString()}</div></div>
        <div class="val ${l.tipo==='receita'?'pos':'neg'}">${brl(l.valor)}</div>
      `;
      el.onclick=()=>{ closeSheet('#sheetCartao'); editarLancamento(l.id); };
      list.appendChild(el);
    });
  }

  // pagar fatura
  $('#btnPagarFatura').onclick=()=>{ pagarCartaoById(curCardId); };

  openSheet('#sheetCartao');
}

/* CRUD Lan√ßamentos */
let editId=null;
function openAddLancamento(pref={}){
  editId=null;
  $('#titleLanc').textContent='Novo lan√ßamento';
  $('#btnExcluirLancTopo').style.display='none';
  $('#tipoMov').value=pref.tipo||'despesa';
  $('#descMov').value=pref.desc||'';
  $('#valorMov').value=pref.valor||'';
  $('#dataMov').value=pref.data||today();
  $('#categoriaMov').value=pref.categoria||($('#tipoMov').value==='receita'?'Sal√°rio':'Cart√£o');
  $('#logoMov').value='';

  const view=currentView();
  const metodoSel = $('#metodoMov'); metodoSel.innerHTML='';
  if(view==='conta'){
    metodoSel.innerHTML = `<option value="conta">Conta</option>`; // somente conta
    $('#fixoWrap').style.display='flex';
  } else if(view==='cartoes'){
    // somente cart√µes
    metodoSel.innerHTML = cards.map(c=>`<option value="cartao:${c.nome}">Cart√£o - ${c.nome}</option>`).join('');
    $('#fixoWrap').style.display='none';
  } else {
    // default conta
    metodoSel.innerHTML = `<option value="conta">Conta</option>`;
    $('#fixoWrap').style.display='flex';
  }

  openSheet('#sheetLancamento');
}
function editarLancamento(id){
  const l=lancamentos.find(x=>x.id===id); if(!l) return;
  editId=l.id; $('#titleLanc').textContent='Editar lan√ßamento';
  $('#btnExcluirLancTopo').style.display='inline-block';
  $('#tipoMov').value=l.tipo; $('#descMov').value=l.desc; $('#valorMov').value=l.valor; $('#dataMov').value=l.data;
  $('#categoriaMov').value=l.categoria;
  // m√©todo conforme origem real do lan√ßamento
  const metodoSel = $('#metodoMov'); metodoSel.innerHTML='';
  if(l.metodo==='conta'){ metodoSel.innerHTML = `<option value="conta">Conta</option>`; $('#fixoWrap').style.display='flex'; }
  else { metodoSel.innerHTML = cards.map(c=>`<option value="cartao:${c.nome}">Cart√£o - ${c.nome}</option>`).join(''); $('#fixoWrap').style.display='none'; }
  metodoSel.value = l.metodo;
  $('#logoMov').value='';
  $('#fixoAno').checked = !!l.seriesId; // informativo
  openSheet('#sheetLancamento');
}
$('#salvarMov').onclick=()=>{
  const isEdit = !!editId;
  const base = {
    tipo: $('#tipoMov').value,
    desc: $('#descMov').value||'Sem descri√ß√£o',
    valor: normMoney($('#valorMov').value),
    data: $('#dataMov').value||today(),
    categoria: $('#categoriaMov').value,
    metodo: $('#metodoMov').value,
  };
  const file=$('#logoMov').files?.[0];
  const applyLogo = (obj,cb)=>{
    if(file){
      const r=new FileReader();
      r.onload=()=>{ obj.logoData=r.result; cb(); };
      r.readAsDataURL(file);
    }else cb();
  };

  // S√©rie fixa no ano (apenas para Conta e ao criar novo)
  const isFixo = $('#fixoAno').checked && base.metodo==='conta' && !isEdit;
  if(isFixo){
    const seriesId = 'S'+Date.now();
    const d = new Date(base.data);
    const dia = d.getDate();
    const ano = d.getFullYear();
    const criaMes = (m)=>{
      const last = new Date(ano, m+1, 0).getDate();
      const dd = Math.min(dia, last);
      const dataStr = new Date(ano, m, dd).toISOString().slice(0,10);
      return { id: Date.now()+m, ...base, data:dataStr, logoData:null, status:'pendente', seriesId };
    };
    const lot = Array.from({length:12},(_,i)=>criaMes(i));
    applyLogo(lot[0],()=>{
      if(lot[0].logoData) for(let i=1;i<lot.length;i++) lot[i].logoData = lot[0].logoData;
      lancamentos.push(...lot);
      save('lancamentos',lancamentos); closeSheet('#sheetLancamento'); render();
      toast('Lan√ßamento fixo criado para todos os meses üìÖ','success');
    });
    return;
  }

  // Fluxo normal (novo ou edi√ß√£o)
  const l = { id: editId || Date.now(), ...base, logoData: null, status: isEdit ? (lancamentos.find(x=>x.id===editId)?.status||'pendente') : 'pendente' };
  applyLogo(l,()=>{
    if(isEdit){ const i=lancamentos.findIndex(x=>x.id===editId); lancamentos[i]={...lancamentos[i],...l}; editId=null; toast('Lan√ßamento atualizado ‚úèÔ∏è','success'); }
    else { lancamentos.push(l); toast('Lan√ßamento adicionado ‚úÖ','success'); }
    save('lancamentos',lancamentos); closeSheet('#sheetLancamento'); render();
  });
};
$('#btnExcluirLancTopo').onclick=()=>{
  if(!editId) return; if(!confirm('Excluir este lan√ßamento?')) return;
  lancamentos = lancamentos.filter(x=>x.id!==editId);
  save('lancamentos',lancamentos); closeSheet('#sheetLancamento'); render();
  toast('Lan√ßamento exclu√≠do üóëÔ∏è','danger');
};

/* CRUD Horas (com dinheiro) */
let editHoraId=null;
function openAddHora(pref={}){
  editHoraId=null;
  $('#btnExcluirHoraTopo').style.display='none';
  $('#dataHora').value = pref.data || today();
  $('#entradaHora').value = pref.entrada || '18:00'; $('#saidaHora').value   = pref.saida   || '22:00';
  $('#almocoHora').value  = pref.almoco  || '00:00';
  $('#percentHora').value = pref.percent || '50';
  $('#salarioHora').value = pref.salarioHora || '';
  openSheet('#sheetHora');
}
function editarHora(id){
  const h=horas.find(x=>x.id===id); if(!h) return;
  editHoraId=h.id;
  $('#btnExcluirHoraTopo').style.display='inline-block';
  $('#dataHora').value=h.data; $('#entradaHora').value=h.entrada; $('#saidaHora').value=h.saida;
  $('#almocoHora').value=minsToTime(h.almocoMin||0); $('#percentHora').value=h.percent; $('#salarioHora').value=h.salarioHora||'';
  openSheet('#sheetHora');
}
$('#salvarHora').onclick=()=>{
  const alm = timeToMin($('#almocoHora').value||'00:00');
  const min = Math.max(0, timeDiff($('#entradaHora').value,$('#saidaHora').value) - alm);
  const sal = normMoney($('#salarioHora').value||0);
  const percent = Number($('#percentHora').value||0);
  const valor = sal ? sal * (min/60) * (1 + percent/100) : 0; // dinheiro
  const h={
    id: editHoraId || Date.now(),
    data: $('#dataHora').value||today(),
    entrada: $('#entradaHora').value, saida: $('#saidaHora').value,
    almocoMin: alm, percent, salarioHora: $('#salarioHora').value||'',
    minutos: min, valor, pago: horas.find(x=>x.id===editHoraId)?.pago||false
  };
  if(editHoraId){ const i=horas.findIndex(x=>x.id===editHoraId); horas[i]={...horas[i],...h}; editHoraId=null; toast('Registro atualizado ‚úèÔ∏è','success'); }
  else { horas.push(h); toast('Horas adicionadas ‚è±Ô∏è','success'); }
  save('horas',horas); closeSheet('#sheetHora'); render();
};
$('#btnExcluirHoraTopo').onclick=()=>{
  if(!editHoraId) return; if(!confirm('Excluir este registro de hora?')) return;
  horas = horas.filter(x=>x.id!==editHoraId);
  save('horas',horas); closeSheet('#sheetHora'); render();
  toast('Registro exclu√≠do üóëÔ∏è','danger');
};

function pagarHora(id){
  const h = horas.find(x=>x.id===id); if(!h) return;
  if(h.pago){ toast('J√° marcado como pago','danger'); return; }
  // Cria receita na conta com a data e valor
  lancamentos.push({
    id: Date.now(),
    tipo:'receita',
    desc:'Hora extra paga',
    valor:h.valor||0,
    data:h.data||today(),
    categoria:'Sal√°rio',
    metodo:'conta',
    status:'pago'
  });
  h.pago = true;
  save('lancamentos',lancamentos); save('horas',horas); render();
  toast('Hora extra paga e lan√ßada na Conta üí∏','success');
}

/* Notas */
$('#salvarNota').onclick=()=>{
  const ns=load('notas',[]); ns.push({id:Date.now(),titulo:$('#tituloNota').value, texto:$('#textoNota').value});
  save('notas',ns); $('#tituloNota').value=''; $('#textoNota').value=''; closeSheet('#sheetNota'); renderNotas();
  toast('Nota salva üìù','success');
};

/* FAB ‚Äî comportamento por view */
$('#fab').onclick = () => {
  const view = currentView();
  if (view === 'hora') openAddHora({});
  else if (view === 'notas') openSheet('#sheetNota');
  else openAddLancamento({});
};

/* Utils */
function timeToMin(t){ const [h,m]=(t||'00:00').split(':').map(Number); return h*60+m; }
function minsToTime(min){ const h=String(Math.floor(min/60)).padStart(2,'0'); const m=String(min%60).padStart(2,'0'); return `${h}:${m}`; }
function timeDiff(a,b){ return timeToMin(b)-timeToMin(a); }
function fmtMin(min){ const h=Math.floor(min/60), m=min%60; return `${h}h ${String(m).padStart(2,'0')}m`; }

/* Inicializa√ß√£o */
render();
setView('cartoes'); // Cart√µes como principal
</script>
</body>
</html>
